<?php
session_start();
require_once 'config.php';
header('Content-Type: text/html; charset=utf-8');

// æœå°‹æ¢ä»¶
$search = isset($_GET['search']) ? trim($_GET['search']) : '';

// åˆ†é è¨­å®š
$limit = 10;
$page = isset($_GET['page']) && is_numeric($_GET['page']) ? (int) $_GET['page'] : 1;
$offset = ($page - 1) * $limit;

// è¨ˆç®—ç¸½ç­†æ•¸
if (!empty($search)) {
    $count_stmt = $pdo->prepare("SELECT COUNT(*) FROM DepartmentTransfer WHERE department_name LIKE :search");
    $count_stmt->bindValue(':search', "%$search%", PDO::PARAM_STR);
    $count_stmt->execute();
} else {
    $count_stmt = $pdo->query("SELECT COUNT(*) FROM DepartmentTransfer");
}
$total_departments = $count_stmt->fetchColumn();
$total_pages = ceil($total_departments / $limit);

// æ’ˆå–ç•¶é è³‡æ–™
if (!empty($search)) {
    $stmt = $pdo->prepare("SELECT department_name, year_2_enrollment, year_3_enrollment, year_4_enrollment, exam_subjects, data_review_ratio FROM DepartmentTransfer WHERE department_name LIKE :search ORDER BY department_name ASC LIMIT :limit OFFSET :offset");
    $stmt->bindValue(':search', "%$search%", PDO::PARAM_STR);
} else {
    $stmt = $pdo->prepare("SELECT department_name, year_2_enrollment, year_3_enrollment, year_4_enrollment, exam_subjects, data_review_ratio FROM DepartmentTransfer ORDER BY department_name ASC LIMIT :limit OFFSET :offset");
}
$stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
$stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
$stmt->execute();
$departments = $stmt->fetchAll(PDO::FETCH_ASSOC);

$pageTitle = 'é¦–é ';
include 'header.php';
?>

<style>
    .card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 0.5rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .search-box {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        margin-bottom: 1.5rem;
    }

    .btn-more {
        padding: 0.5rem 1.5rem;
        background-color: rgb(104, 128, 151);
        text-decoration: none;
        color: white;
        border-radius: 0.5rem;
    }

    .btn-more:hover {
        color: white;
        background-color: rgb(115, 149, 179)
    }

    .btn-search {
        padding: 0.5rem 1.5rem;
        background-color: rgb(75, 100, 158);
        text-decoration: none;
        color: white;
        border: none !important;
        outline: none !important;
        border-radius: 0.5rem;
    }

    .btn-search:hover {
        color: white;
        background-color: rgb(91, 120, 189);
    }

    .btn-add {
        padding: 0.5rem 1.5rem;
        background-color: rgb(87, 148, 100);
        text-decoration: none;
        color: white;
        border: none !important;
        outline: none !important;
        border-radius: 0.5rem;
    }

    .btn-add:hover {
        color: white;
        background-color: rgb(100, 170, 115);
    }

    .btn-remove {
        padding: 0.5rem 1.5rem;
        background-color: rgb(203, 82, 66);
        text-decoration: none;
        color: white;
        border: none !important;
        outline: none !important;
        border-radius: 0.5rem;
    }

    .btn-remove:hover {
        color: white;
        background-color: rgb(207, 109, 96);
    }

    .btn-compare {
        padding: 0.5rem 1.5rem;
        color: white;
        outline: none;
        border-radius: 0.5rem;
        text-decoration: none;
        background-color: rgb(87, 148, 100);
    }

    .btn-compare:hover {
        background-color: rgb(124, 205, 151);
        color: black !important;
    }

    .btn-compare1 {
        padding: 0.5rem 1.5rem;
        color: white;
        outline: none;
        border-radius: 0.5rem;
        text-decoration: none;
    }

    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .department-link {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }

    .department-link:hover {
        color: #0b5ed7;
        text-decoration: underline;
    }

    .dropdown-menu {
        background-color: lightgray;
        color: rgb(42, 38, 40);
        border-radius: 0.5rem;
    }

    .dropdown-menu .dropdown-item:hover {
        background-color: #f5f5f5;
        color: rgb(42, 38, 40);
    }

    .page-item.active .page-link {
        background-color: rgb(85, 89, 87);
        border-color: rgb(65, 68, 67);
        color: #fff;
    }

    .page-link {
        color: rgb(85, 89, 87);
        border-color: rgb(65, 68, 67);
    }

    .page-link:hover {
        background-color: rgba(224, 232, 228, 0.5);
        color: #081c15;
    }

    .btn-Faculty {
        background-color: #e9ecef;
        color: #333;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 2rem;
        margin: 0.4rem;
        font-weight: 500;
        transition: 0.2s ease;
    }

    .btn-Faculty:hover {
        background-color: #d6d6d6;
        color: black;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="container-fluid">
    <!-- ä¸»å…§å®¹ï¼šå·¦å´é‚Šæ¬„ + ä¸­é–“å…§å®¹ -->
    <div class="row">
        <!-- å·¦å´é‚Šæ¬„ -->
        <aside class="col-md-2 bg-light border-end vh-100 pt-4">
            <h5 class="px-3">ğŸ”– å¿«æ·åŠŸèƒ½</h5>
            <ul class="nav flex-column px-3">
                <li class="nav-item mb-2"><a href="#" class="nav-link text-dark">â–¸ æœ€è¿‘ç€è¦½ï¼ˆ3-4 ç­†ï¼‰</a></li>
                <li class="nav-item mb-2"><a href="#" class="nav-link text-dark">â–¸ è¨­å®šæé†’</a></li>
                <li class="nav-item mb-2"><a href="#" class="nav-link text-dark">â–¸ è½‰ç³» Q&A</a></li>
            </ul>
        </aside>

        <!-- ä¸­é–“ä¸»å…§å®¹ -->
        <main class="col-md-10 pt-4 px-5">
            <!-- ä¸»è¦å…§å®¹ -->
            <div class="container mt-5 pt-5">
                <!-- æœå°‹æ¡† -->
                <div class="search-box">
                    <form method="GET" class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-grow-1 me-3">
                            <input type="text" name="search" class="form-control form-control-lg" placeholder="æœå°‹ç³»æ‰€..." value="<?= htmlspecialchars($search) ?>">
                            <button type="submit" class="btn btn-search ms-2">æœå°‹</button>
                        </div>
                    </form>
                </div>

                <!-- âœ… å­¸é™¢æŒ‰éˆ•åˆ— -->
                <div class="d-flex flex-wrap justify-content-center mb-4">
                    <button class="btn-Faculty me-2 mb-2" data-college="æ–‡å­¸é™¢">æ–‡å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="è—è¡“å­¸é™¢">è—è¡“å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="å‚³æ’­å­¸é™¢">å‚³æ’­å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="æ•™è‚²èˆ‡é‹å‹•å­¸é™¢">æ•™è‚²èˆ‡é‹å‹•å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="é†«å­¸é™¢">é†«å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="ç†å·¥å­¸é™¢">ç†å·¥å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="å¤–åœ‹èªæ–‡å­¸é™¢">å¤–åœ‹èªæ–‡å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="æ°‘ç”Ÿå­¸é™¢">æ°‘ç”Ÿå­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="æ³•å¾‹å­¸é™¢">æ³•å¾‹å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="ç¤¾æœƒç§‘å­¸é™¢">ç¤¾æœƒç§‘å­¸é™¢</button>
                    <button class="btn-Faculty me-2 mb-2" data-college="ç®¡ç†å­¸é™¢">ç®¡ç†å­¸é™¢</button>
                </div>

                <div id="departmentTableSection">
                    <div id="default-table">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ç³»æ‰€åç¨±</th>
                                        <th>äºŒå¹´ç´šåé¡</th>
                                        <th>ä¸‰å¹´ç´šåé¡</th>
                                        <th>å››å¹´ç´šåé¡</th>
                                        <th>è€ƒè©¦ç§‘ç›®</th>
                                        <th>è³‡æ–™å¯©æŸ¥</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if (empty($departments)): ?>
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <i class="bi bi-info-circle text-muted"></i> æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„ç³»æ‰€
                                            </td>
                                        </tr>
                                    <?php else: ?>
                                        <?php foreach ($departments as $dept): ?>
                                        <tr>
                                            <td>
                                                <a href="department_detail.php?name=<?= urlencode($dept['department_name']) ?>" class="department-link">
                                                    <?= htmlspecialchars($dept['department_name']) ?>
                                                </a>
                                            </td>
                                            <td><?= $dept['year_2_enrollment'] ? htmlspecialchars($dept['year_2_enrollment']) : 'ç„¡' ?></td>
                                            <td><?= $dept['year_3_enrollment'] ? htmlspecialchars($dept['year_3_enrollment']) : 'ç„¡' ?></td>
                                            <td><?= $dept['year_4_enrollment'] ? htmlspecialchars($dept['year_4_enrollment']) : 'ç„¡' ?></td>
                                            <td><?= $dept['exam_subjects'] ? htmlspecialchars($dept['exam_subjects']) : 'ç„¡' ?></td>
                                            <td><?= $dept['data_review_ratio'] ? htmlspecialchars($dept['data_review_ratio']) : 'ç„¡' ?></td>
                                            <td>
                                                <div class="d-flex gap-2">
                                                    <a href="department_detail.php?name=<?= urlencode($dept['department_name']) ?>" class="btn btn-sm btn-outline-primary" style="white-space: nowrap;">
                                                        <i class="bi bi-info-circle"></i> è©³ç´°è³‡è¨Š
                                                    </a>
                                                    <button onclick="toggleCompare('<?= htmlspecialchars($dept['department_name']) ?>')" class="btn btn-sm btn-outline-success" style="white-space: nowrap;">
                                                        <i class="bi bi-plus-circle"></i> åŠ å…¥æ¯”è¼ƒ
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mt-4">
                                <?php if ($page > 1): ?>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<?= $page - 1 ?><?= $search ? '&search=' . urlencode($search) : '' ?>">ä¸Šä¸€é </a>
                                    </li>
                                <?php endif; ?>
                                
                                <?php for ($i = 1; $i <= $total_pages; $i++): ?>
                                    <li class="page-item <?= $i === $page ? 'active' : '' ?>">
                                        <a class="page-link" href="?page=<?= $i ?><?= $search ? '&search=' . urlencode($search) : '' ?>"><?= $i ?></a>
                                    </li>
                                <?php endfor; ?>
                                
                                <?php if ($page < $total_pages): ?>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<?= $page + 1 ?><?= $search ? '&search=' . urlencode($search) : '' ?>">ä¸‹ä¸€é </a>
                                    </li>
                                <?php endif; ?>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
function toggleCompare(departmentName) {
    let compareList = JSON.parse(localStorage.getItem('compare_departments') || '[]');
    
    if (compareList.includes(departmentName)) {
        compareList = compareList.filter(name => name !== departmentName);
        alert('å·²å¾æ¯”è¼ƒæ¸…å–®ä¸­ç§»é™¤');
    } else {
        if (compareList.length >= 3) {
            alert('æœ€å¤šåªèƒ½æ¯”è¼ƒä¸‰å€‹ç³»æ‰€ï¼');
            return;
        }
        compareList.push(departmentName);
        alert('å·²åŠ å…¥æ¯”è¼ƒæ¸…å–®');
    }
    
    localStorage.setItem('compare_departments', JSON.stringify(compareList));
    updateCompareCount();
    window.location.href = 'compare.php';
}
</script>

<?php include 'footer.php'; ?>